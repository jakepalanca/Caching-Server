name: Deploy to EC2 on Master Push

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Set up SSH key and known hosts with enhanced debugging
      - name: Set up SSH key and known hosts
        run: |
          echo "Setting up SSH keys..."
          export HOME=/home/runner
          mkdir -p $HOME/.ssh
          
          # Remove any Windows carriage return characters and save the key
          echo "${{ secrets.PEM_FILE }}" | tr -d '\r' > $HOME/.ssh/Github-Action-1.pem
          chmod 400 $HOME/.ssh/Github-Action-1.pem
          
          # Start the SSH agent and add the key
          eval "$(ssh-agent -s)"
          ssh-add $HOME/.ssh/Github-Action-1.pem || { echo "Failed to add SSH key"; exit 1; }
          
          # Retry ssh-keyscan to prevent network-related issues
          for i in {1..5}; do
            ssh-keyscan -H ec2-34-229-99-144.compute-1.amazonaws.com >> $HOME/.ssh/known_hosts && break || sleep 2
          done
          
          chmod 644 $HOME/.ssh/known_hosts
          echo "SSH keys set up completed."

      # Optional: Test SSH Connection Immediately After Setup with enhanced verbosity
      - name: Test SSH Connection Immediately
        run: |
          echo "Testing SSH connection right after setting up the keys..."
          ssh -i $HOME/.ssh/Github-Action-1.pem -o StrictHostKeyChecking=no -v ec2-user@ec2-50-17-144-60.compute-1.amazonaws.com "echo SSH Connection Successful"
        timeout-minutes: 1

      # Additional debug to confirm IP reachability
      - name: Test Instance Availability (Ping)
        run: |
          echo "Testing reachability of EC2 instance..."
          ping -c 4 ec2-50-17-144-60.compute-1.amazonaws.com || { echo "Ping to EC2 failed"; exit 1; }
